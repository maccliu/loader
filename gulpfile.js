// --------------------------------------------------------------------------------
// gulp
// --------------------------------------------------------------------------------

const gulp = require("gulp");
const { src, dest, series, parallel, watch } = gulp;

// --------------------------------------------------------------------------------
// gulp plugins
// --------------------------------------------------------------------------------

const del = require("del");
const rename = require("gulp-rename");
const uglify = require("gulp-uglify");
const uglify_conf = {
  output: {
    comments: /^[ \*]{0,}\!/, // 保留以!开头的注释
  },
};
const babel = require("gulp-babel");

// --------------------------------------------------------------------------------
// task functions
// --------------------------------------------------------------------------------

function task_clean(done) {
  del(["dist/**/*"]);
  done();
}

function task_src(done) {
  src("src/loader.js")
    .pipe(dest("dist/"))

    // minify
    .pipe(uglify(uglify_conf))
    .pipe(rename({ extname: ".min.js" }))
    .pipe(dest("dist/"));

  // done 
  done();
}

// ----------------------------------------------------------------------------------------------------
// tasks
// ----------------------------------------------------------------------------------------------------

gulp.task("clean", task_clean);
gulp.task("src", task_src);

// ----------------------------------------------------------------------------------------------------
// watch
// ----------------------------------------------------------------------------------------------------

gulp.task("watch", function() {
  watch("src/**/*", series("src"));
})

// ----------------------------------------------------------------------------------------------------
// exports
// ----------------------------------------------------------------------------------------------------

exports.default = series(
  "clean",
  parallel("src")
);